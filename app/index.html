<!DOCTYPE html>

<!-- define angular app -->
<html id="ng-app">

<head>
    <meta charset="utf-8">
    <title>NDEx WebApp</title>
    <meta name="description" content="NDEx, the Network Data Exchange, is a collaborative software infrastructure for storing, sharing and publishing biological network knowledge; NDEx is developed in tight association with Cytoscape at the UC San Diego School of Medicine.">
    <meta name="viewport" content="width=device-width">


    <!-- build:css(app) styles/vendor.css -->
    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/textAngular/dist/textAngular.css" />
    <link rel="stylesheet" href="bower_components/angular-ui-grid/ui-grid.css" />
    <link rel="stylesheet" href="bower_components/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="bower_components/slick-carousel/slick/slick.css" />
    <link rel="stylesheet" href="bower_components/angular-bootstrap-toggle/dist/angular-bootstrap-toggle.min.css" />
    <!-- endbower -->
    <link type="text/css" rel="stylesheet" href="bower_components/qtip2/jquery.qtip.css" />
    <!-- endbuild -->
    <!-- build:css(.tmp) styles/main.css -->
    <link rel="stylesheet" href="styles/ndex-angular-site.css"/>
    <link rel="stylesheet" href="styles/visualize_network.css"/>
    <!-- endbuild -->

    <!-- it is important to load angular *after* jQuery if you want angular to have access
         to full jQuery functionality instead of angular's internal 'lite' version -->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans" type="text/css">

    <!-- build:js(app) scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/angular-animate/angular-animate.js"></script>
    <script src="bower_components/angular-cookies/angular-cookies.js"></script>
    <script src="bower_components/angular-resource/angular-resource.js"></script>
    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="bower_components/angular-touch/angular-touch.js"></script>
    <script src="bower_components/cytoscape/dist/cytoscape.umd.js"></script>
    <script src="bower_components/ev-emitter/ev-emitter.js"></script>
    <script src="bower_components/imagesloaded/imagesloaded.js"></script>
    <script src="bower_components/qtip2/jquery.qtip.js"></script>
    <script src="bower_components/qtip2/basic/jquery.qtip.js"></script>
    <script src="bower_components/cytoscape-qtip/cytoscape-qtip.js"></script>
    <script src="bower_components/cytoscape-cx2js/build/bundle.js"></script>
    <script src="bower_components/cyannotation-cx2js/dist/build/bundle.js"></script>
    <script src="bower_components/lodash/lodash.js"></script>
    <script src="bower_components/angular-file-upload/dist/angular-file-upload.min.js"></script>
    <script src="bower_components/rangy/rangy-core.js"></script>
    <script src="bower_components/rangy/rangy-classapplier.js"></script>
    <script src="bower_components/rangy/rangy-highlighter.js"></script>
    <script src="bower_components/rangy/rangy-selectionsaverestore.js"></script>
    <script src="bower_components/rangy/rangy-serializer.js"></script>
    <script src="bower_components/rangy/rangy-textrange.js"></script>
    <script src="bower_components/textAngular/dist/textAngular.js"></script>
    <script src="bower_components/textAngular/dist/textAngular-sanitize.js"></script>
    <script src="bower_components/textAngular/dist/textAngularSetup.js"></script>
    <script src="bower_components/angular-ui-grid/ui-grid.js"></script>
    <script src="bower_components/spin.js/spin.js"></script>
    <script src="bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
    <script src="bower_components/clipboard/dist/clipboard.js"></script>
    <script src="bower_components/ngclipboard/dist/ngclipboard.js"></script>
    <script src="bower_components/to-markdown/dist/to-markdown.js"></script>
    <script src="bower_components/moment/moment.js"></script>
    <script src="bower_components/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <script src="bower_components/angular-google-analytics/dist/angular-google-analytics.min.js"></script>
    <script src="bower_components/slick-carousel/slick/slick.js"></script>
    <script src="bower_components/angular-slick/dist/slick.js"></script>
    <script src="bower_components/ngtweet/dist/ngtweet.js"></script>
    <script src="bower_components/angular-bootstrap-toggle/dist/angular-bootstrap-toggle.min.js"></script>
    <script src="bower_components/cytoscape-canvas/src/cytoscape-canvas.js"></script>
    <!-- endbower -->
    <!-- endbuild -->

    <!-- Load script that may redirect to maint.html -->

 <!--   <script src="checkMaintenance.js"></script>  -->


    <!-- Scripts -->

    <!-- it is important to load angular *after* jQuery if you want angular to have access
         to full jQuery functionality instead of angular's internal 'lite' version -->


    <script src="https://apis.google.com/js/api.js"></script>
    <script src="ndex-webapp-config.js"></script>


    <!-- build:js({.tmp,app}) scripts/scripts.js -->

    <!-- ndex scripts -->
    <script src="scripts/init.js"></script>
    <script src="scripts/ndex-service-app.js"></script>
    <script src="scripts/ndex-service-factory.js"></script>
    <script src="scripts/services/networkService.js"></script>
    <script src="scripts/ui-service.js"></script>
    <script src="scripts/services/network-set-service.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/services/sharedProperties.js"></script>
    <script src="scripts/services/ui-misc.js"></script>
    <script src="scripts/services/log-in-service.js"></script>
    <script src="scripts/services/spinner-service.js"></script>
    <script src="scripts/services/user-session-tables-settings.js"></script>

    <!-- page controllers -->
    <script src="scripts/controllers/main.js"></script>
    <script src="scripts/controllers/sign-in-controller.js"></script>
    <script src="scripts/controllers/search-controller.js"></script>
    <script src="scripts/controllers/network-controller.js"></script>
    <script src="scripts/controllers/user-controller.js"></script>
    <script src="scripts/controllers/upload-controller.js"></script>
    <script src="scripts/controllers/group-controller.js"></script>
    <script src="scripts/controllers/network-set-controller.js"></script>
    <script src="scripts/controllers/edit-network-properties-controller-fixed-form.js"></script>
    <script src="scripts/controllers/manage-network-access.js"></script>
    <script src="scripts/controllers/manage-bulk-network-access.js"></script>
    <script src="scripts/controllers/manage-group-access.js"></script>
 <!--   <script src="scripts/controllers/api-controller.js"></script>  -->
    <script src="scripts/controllers/home-controller.js"></script>
    <script src="scripts/controllers/my-account-controller.js"></script>

    <!-- endbuild -->

    <noscript>
        <!-- This will execute if JavaScript is disabled in the browser -->
        <div class="jsOrCookiesDisabledWarning">
            JavaScript is not enabled in your browser. <br>
            NDEx requires that JavaScript be enabled. <br>
            Please turn JavaScript on and try again.
        </div>
    </noscript>

    <!-- This element will be filled in and shown in case  cookies are blocked by the browser -->
    <div id="noCookiesEnabledId"></div>

</head>

<!-- define angular controller -->
<body ng-controller="mainController" style="height: 100%;">

<!-- template for search bar -->
<script type="text/ng-template" id="search_bar.html">

    <form ng-show="!main.serverIsDown && (!config.requireAuthentication||main.loggedIn)"
          ng-submit="main.search()">

        <table class="table">

            <div class="input-group">

                <tr style="background: transparent;">
                    <td width="15%;" style="border:hidden;">

                        <div class="row">
                            <button type="button" class="btn btn-primary search-examples-button"
                                    ng-click="main.browse(); closeModal()">
                                Latest Networks
                            </button>
                        </div>

                        <div class="row">
                            <div class="dropdown">
                                <button type="button"
                                        ng-class="featuredNetworksDropDownEnabled?
                                            'btn btn-primary dropdown-toggle search-examples-button':'btn btn-primary search-examples-button disabled'"
                                        data-toggle="dropdown">
                                    Featured Networks <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu">
                                    <li ng-repeat="item in featuredNetworksDropDown">
                                        <a href="{{item.href}}">{{item.description}}</a>
                                    </li>
                                </ul>

                            </div>
                        </div>

                        <div class="row">
                            <div class="dropdown">
                                <button type="button" class="btn btn-primary dropdown-toggle search-examples-button"
                                        data-toggle="dropdown">
                                    Search Examples <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu">
                                    <li class="AlignLeft" style="padding-left: 5px;"
                                        ng-repeat="item in main.searchNetworksExamples">
                                        <a ng-click="main.runSearchExample(item); closeModal()">
                                            {{item.description}}
                                        </a>
                                    </li>

                                    <li class="AlignLeft" ng-show="config.searchDocLink">
                                        <a style="color:#428bca; background-color:white;"
                                           ng-click="redirectToExternalLink(config.searchDocLink); closeModal()">
                                            <u>{{config.searchDocLink.label}}</u>
                                        </a>
                                    </li>

                                </ul>
                            </div>
                        </div>

                    </td>

                    <!-- #87cefa -->
                    <td width="85%" style="border:hidden">
                        <div class='row' style="margin-left: 1em; margin-right: 0">
                            <div class="input-group">

                                <input type="text"
                                       class="form-control inputHeight"
                                       style="font-size:1.3em;"
                                       placeholder="{{main.getSearchPlaceholder()}}"
                                       ng-model="main.searchString"
                                       maxlength="{{maxSearchInputLength}}"
                                       ng-change="checkLengthOfSearchString()">

                                <span class="input-group-btn">
                                    <button ng-disabled="!main.searchString" type="submit" ng-click="closeModal();"
                                            ng-class="main.searchString ? 'btn btn-primary inputHeight' : 'btn btn-default inputHeight'">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class='row' style="margin-left: 1em; margin-top: 1.5em">

                            <div ng-show='stringTooLongWarning' style="color:red; font-size:1.1em; font-weight:bold; margin-bottom: 1em"
                                 ng-bind-html="stringTooLongWarning">
                            </div>

                            <input type="checkbox"
                                   ng-hide="checkSearchTypeAndTermExpansion()"
                                   ng-model="main.searchTermExpansionSelected">

                            <span ng-style="searchTermExpansionEnabled ?
                                {'color':'black', 'font-size':'1.1em'} : {'color':'red', 'font-size':'1.1em'}">
                                    <strong>{{main.searchTitle}}</strong>
                                 &nbsp;
                                <i data-toggle="tooltip"
                                   data-placement="bottom"
                                   title="{{popupTitleInSearchModal}}"
                                   onmouseenter="$(this).tooltip('show')"
                                   class="fa fa-info-circle" style="color: #3576BE; cursor: pointer;"
                                   ng-if="searchTermExpansionEnabled">

                                </i>
                            </span>


                        </div>
                    </td>
                </tr>
            </div>

        </table>

    </form>

</script>

<!-- Nav Bar -->
<nav id="topNavBarId" class="navbar navbar-fixed-top" style="display: none;">

    <div class="navbar-ndex navbar-ndex-top">

        <div class="container-fluid" style="width:100%; max-width: 1460px;">

            <div class="navbar-header navbar-top-height navbar-ndex-logo-margin">

                <button ng-show="(main.serverIsDown != null) && !main.serverIsDown"
                        type="button"
                        class="navbar-toggle"
                        data-toggle="collapse"
                        data-target="#myNavbar"
                        ng-click="switchNav($event)"
                        style="padding-top: 21px">

                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a class="navbar-brand"
                   style="padding: 5px 0 5px 0px"
                   ng-click="collapseHamburgerMenu(); goToLandingPage()">
                    <div id="ndexLogoId" style="
                        display: none;
                        background-image: url('images/new_landing_page_logo.png');
                        background-repeat: no-repeat;
                        width: 310px;
                        height: 65px;
                        background-size: 310px 65px;">
                    </div>
                </a>

                <div class="ndexServerVersion"
                     style="margin-left: 320px;  padding-top: 42px; height: 65px; width: 65px; text-decoration: underline">
                    <a id="ndexServerVersionId"
                        ng-href="{{linkToReleaseDocs}}"
                       target="release_tab"
                       data-toggle="tooltip"
                       title="Release Notes"
                       data-placement="bottom"> v{{main.ndexServerVersion}}
                    </a>
                </div>
            </div>

            <div class="navbar-collapse collapse" id="myNavbar">

                <ul id="topMenuId" class="nav navbar-nav navbar-left" style="display: none; padding-top: 14px"
                    ng-show="(main.serverIsDown != null) && !main.serverIsDown">

                    <li ng-repeat="item in topMenu">
                        <a ng-href="{{$location.path()}}"
                           ng-click="collapseHamburgerMenu(); redirectToExternalLink(item)">
                            {{item.label}}
                        </a>
                    </li>
                </ul>

                <ul id="searchMyAccountNameLoginId" class="nav navbar-nav navbar-right" style="display: none; padding-top: 14px">

                    <li ng-show="isSearchIconVisible()" data-toggle="tooltip"
                        title="Browse networks, search by keywords or gene and access featured networks in NDEx"
                        data-placement="bottom">
                        <a ng-click="collapseHamburgerMenu(); showSearchBar()">
                            <div style="
                                background-image: url('images/search-icon.png');
                                margin-top: -5px;
                                margin-bottom: -5px;
                                width: 30px;
                                height: 30px;
                                background-size: 30px 30px;"
                                class="marginForCollapsedMode">
                            </div>
                        </a>
                    </li>


                    <li ng-show="main.loggedIn">
                        <a ng-click="collapseHamburgerMenu(); main.goToCurrentUser()">
                            <img src="images/home.png"
                                 style="float:left; width:30px; height:30px; margin-bottom:-5px; margin-top:-5px;"
                                 class="marginForCollapsedMode">
                            &nbsp;&nbsp;{{main.userFirstAndLastNames}}!
                        </a>
                    </li>

                    <li ng-show="main.loggedIn">
                        <button type="button" class="btn btn-primary login-button"
                                ng-click="collapseHamburgerMenu();
                                main.signout()">
                            Logout
                        </button>
                    </li>


                    <li ng-show="!main.loggedIn && !config.requireAuthentication && !main.serverIsDown && main.showSignIn">
                        <button type="button" class="btn btn-primary login-button"
                           ng-click="collapseHamburgerMenu();
                                 main.showSignInSignUpOptions()"
                                data-toggle="tooltip"
                                title="Log in or create a new account&nbsp;&nbsp;"
                                data-placement="bottom">
                            Login/Register
                        </button>
                    </li>

                </ul>

            </div>

            <div class="sidenav" id="slidingRightMenuDivId">

                <ul id="slidingRightMenuId" class="nav navbar-nav navbar-left hideLongLine" style="display: none; padding-top: 14px"
                    ng-show="(main.serverIsDown != null) && !main.serverIsDown">

                    <li ng-repeat="item in topMenu">
                        <a ng-href="{{$location.path()}}"
                           ng-click="switchNav($event); redirectToExternalLink(item)">
                            {{item.label}}
                        </a>
                    </li>
                </ul>

                <ul id="slidingRightMenuSearchMyAccountNameLoginId"
                    class="nav navbar-nav navbar-left hideLongLine" style="display: none; padding-top: 14px">

                    <li ng-show="isSearchIconVisible()">
                        <a ng-click="switchNav($event); showSearchBar()">
                            <div style="
                                background-image: url('images/search-icon.png');
                                margin-top: -5px;
                                margin-bottom: -5px;
                                width: 30px;
                                height: 30px;
                                background-size: 30px 30px;"
                                 class="marginForCollapsedMode">
                            </div>
                        </a>
                    </li>


                    <li ng-show="main.loggedIn">
                        <a ng-click="switchNav($event); main.goToCurrentUser()">
                            <img src="images/home.png"
                                 style="float:left; width:30px; height:30px; margin-bottom:-5px; margin-top:-5px;"
                                 class="marginForCollapsedMode">
                            &nbsp;&nbsp;{{main.userFirstAndLastNames}}!
                        </a>
                    </li>

                    <li ng-show="main.loggedIn">
                        <button type="button" class="btn btn-primary login-button"
                                ng-click="switchNav($event);
                                main.signout()">
                            Logout
                        </button>
                    </li>


                    <li ng-show="!main.loggedIn && !config.requireAuthentication && !main.serverIsDown && main.showSignIn">
                        <button type="button" class="btn btn-primary login-button"
                                ng-click="switchNav($event);
                                 main.showSignInSignUpOptions()">
                            Login/Register
                        </button>
                    </li>

                </ul>

            </div>

        </div>
    </div>

</nav>

<div id="main" class="container-fluid marginsForNGView flexContent">
    <!-- angular templating -->
    <!-- this is where content will be injected -->

    <div ng-view></div>

</div>

<div id="footerId" ng-if="footerHtml" class="container-fluid ndexFooter ndexFooterProps" style="display: none;" >
    <div class="container-fluid" style="width:100%; max-width: 1460px;">
        <ng-include src="footerHtml"></ng-include>
    </div>
</div>

<!--
<div id="footerId" style="display: none;">
    <nav class="navbar navbar-ndex navbar-fixed-bottom footer-bar AlignLeft">
        <div class='footer-content' >

            <div class="row">

                <div class="col-10 col-xs-10 col-sm-10 col-md-10 navbar-ndex-bottom" style="padding-top: 6px;">

                    <div ng-repeat="item in footerNav" style="display: inline; margin-left: 30px;" >
                        <a ng-if='item.href' ng-href="{{item.href}}" target="_blank" style='color: #149FEC;'>
                            {{item.label}}
                        </a>
                        <span ng-if='!item.href' style='color: #149FEC;'>
                            {{item.label}}
                        </span>
                    </div>

                    <a id="copyNDExCitationToClipboardId"
                       data-toggle="tooltip"
                       data-placement="top"
                       ng-mouseover="changeTitle()"
                       ng-init="setToolTips()"
                       ngclipboard
                       data-clipboard-text="{{NDEx.citation}}"
                        style="margin-left: 30px; color: #149FEC;">
                        Citing NDEx
                    </a>
                </div>

                <div class="col-2 col-xs-2 col-sm-2 col-md-2">
                    <ul class="social pull-right" style="min-width: 154px; max-width: 154px; width: 100%">
                        <li class="twitter">
                            <a href="https://twitter.com/NDExProject">
                                <i class="fa fa-twitter"></i>
                            </a>
                        </li>
                        <li class="youtube">
                            <a href="https://www.youtube.com/channel/UCc7J1020F7e25F-zWEMtM0A">
                                <i class="fa fa-youtube"></i>
                            </a>
                        </li>
                        <li class="linkedin">
                            <a href="https://www.linkedin.com/company/3991823">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </nav>
</div>
-->


<script>

    function logInUserWithBasicAuth() {
        var initInjector = angular.injector(["ng"]);
        var $http = initInjector.get("$http");

        var loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

        if (loggedInUser) {
            $http({
                    method: 'GET',
                    url: ndexSettings.ndexServerUri + "/user?valid=true&setAuthHeader=false",
                    headers: {
                        Authorization: "Basic " + btoa(loggedInUser.userName + ":" + loggedInUser.token)
                    }
                }
            )
            .success(function(data, status, headers, config, statusText) {
                startWebApp(data, 'basic');
            })
            .error(function(error, status, headers, config, statusText) {
                startWebApp(null,null);
            })
        } else {
            try {
                angular.bootstrap(document, ['ndexApp']);
            } catch(e) {
                //already loaded; do not do anything here; we use the try .. catch block to silence up
                // an error message in case angular.bootstrap(document, ['ndexApp']); throws an exception
            }
        }
    }

    function initClient() {
      gapi.client.init({
          clientId: ndexSettings.googleClientId,
          scope: 'profile email',
      }).then(function () {
          const initInjector = angular.injector(["ng"]);
          const $http = initInjector.get("$http");

          isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();

          if (isSignedIn) {
              const curUser = gapi.auth2.getAuthInstance().currentUser.get();
              const id_token = curUser.getAuthResponse().id_token;

              $http({
                  method: 'GET',
                  url: ndexSettings.ndexServerUri + "/user?valid=true&setAuthHeader=false",
                  headers: {
                      Authorization: "Bearer " + id_token
                    }
                  }
              )
              .success(function(data, status, headers, config, statusText) {
                  startWebApp(data, 'google');
              })
              .error(function(error, status, headers, config, statusText) {
                  startWebApp(null,null);
              })

          } else {

              logInUserWithBasicAuth();

          }
      }, function(error) {

          // this is the case where 3rd parties cookies are blocked by the browser.
          // Google SSO is therefore unavailable.  Log in with Basic Auth.

          //localStorage.setItem('noGoogleSSO', 'true');
          window.googleSSO = false;
          logInUserWithBasicAuth();
      });

  }

    function startWebApp (signedInUser, type) {

      if ( signedInUser !=null ) {
          window.currentNdexUser = signedInUser;
          window.currentSignInType = type;
      }
      try {
          angular.bootstrap(document, ['ndexApp']);
      } catch(e) {
          //already loaded; do not do anything here; we use the try .. catch block to silence up
          // an error message in case angular.bootstrap(document, ['ndexApp']); throws an exception
      }
  }

    if (location.protocol !== 'https:') {
        location.replace(`https:${location.href.substring(location.protocol.length)}`);
    }

    if (navigator.cookieEnabled) {

        window.googleSSO = true;

     //   window.isSafari = false;
           /*/constructor/i.test(window.HTMLElement) || (function (p) {
                return p.toString() === "[object SafariRemoteNotification]";
            })(!window['safari'] || safari.pushNotification); */

        if (typeof ndexSettings === 'undefined') {
            alert("We have updated our web site. Please reload this page.\n\nIf this error still exists after refreshing this page, please contact us at admin@ndexbio.org with error message: \"Couldn't load ndex-webapp-config.js file\".");
        } else {
            gapi.load('client:auth2', initClient);
        }

    } else {

        // cookies are blocked by the browser - NDEx cannot run since localStorage is unavailable

        document.getElementById("noCookiesEnabledId").innerHTML =
            '<div class="jsOrCookiesDisabledWarning">' +
            'Cookies are blocked by your browser. <br>' +
            'NDEx requires that cookies be unblocked. <br>' +
            'Please unblock cookies and try again. </div>';
    }


</script>

</body>

</html>
